<!DOCTYPE html>
<html>
<head>
  <title>Peer Tutor App</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: linear-gradient(to right, #eef2f3, #8e9eab);
      color: #333;
    }

    h2 {
      text-align: center;
      font-weight: 600;
      color: #222;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-top: 20px;
    }

    .box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      flex: 1;
      min-width: 320px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .box:hover {
      transform: scale(1.01);
    }

    input, select {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      outline-color: #4a90e2;
    }

    button {
      padding: 10px 16px;
      margin-top: 10px;
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    button:hover {
      background-color: #357ab8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #fafafa;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
      font-weight: 600;
    }

    .match-message {
      font-weight: 600;
      font-size: 16px;
      color: #1f883d;
      margin-bottom: 10px;
      background: #e6ffed;
      padding: 10px;
      border-left: 4px solid #34d058;
      border-radius: 4px;
    }

    .logout {
      background-color: #e74c3c;
      float: right;
    }

    .logout:hover {
      background-color: #c0392b;
    }

    .hide {
      display: none;
    }
  </style>
</head>
<body>

<h2>Peer Tutor App</h2>

<div id="authBox" class="box">
  <h3>Login / Sign Up</h3>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
</div>

<div id="mainApp" class="hide">
  <button class="logout" onclick="logout()">Logout</button>
  <p>Signed in as: <b><span id="displayUsername"></span></b></p>

  <div class="container">
    <div class="box">
      <h3>Register as Tutor</h3>
      <input type="text" id="tutorGrade" placeholder="Enter your grade (e.g., 7)">
      <select id="tutorSubject" onchange="toggleOther(this, 'tutorOther')">
        <option value="">Select Subject</option>
        <option value="Math">Math</option>
        <option value="Lit and Comp">Lit and Comp</option>
        <option value="Writing">Writing</option>
        <option value="Social Studies">Social Studies</option>
        <option value="Science">Science</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="tutorOther" placeholder="Enter subject" style="display:none">
      <button onclick="registerTutor()">Register Tutor</button>
    </div>

    <div class="box">
      <h3>Register as Help Seeker</h3>
      <input type="text" id="seekerGrade" placeholder="Enter your grade (e.g., 6)">
      <select id="seekerSubject" onchange="toggleOther(this, 'seekerOther')">
        <option value="">Select Subject</option>
        <option value="Math">Math</option>
        <option value="Lit and Comp">Lit and Comp</option>
        <option value="Writing">Writing</option>
        <option value="Social Studies">Social Studies</option>
        <option value="Science">Science</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="seekerOther" placeholder="Enter subject" style="display:none">
      <button onclick="registerSeeker()">Register Seeker</button>
    </div>
  </div>

  <div class="container">
    <div class="box">
      <h3>Available Tutors</h3>
      <table>
        <thead><tr><th>Username</th><th>Subject</th><th>Grade</th></tr></thead>
        <tbody id="tutorList"></tbody>
      </table>
    </div>

    <div class="box">
      <h3>Help Seekers</h3>
      <table>
        <thead><tr><th>Username</th><th>Subject</th><th>Grade</th><th>Action</th></tr></thead>
        <tbody id="seekerList"></tbody>
      </table>
    </div>
  </div>

  <div class="container">
    <div class="box">
      <h3>Matched Tutors & Seekers</h3>
      <div id="matchMessage" class="match-message"></div>
      <table>
        <thead><tr><th>Help Seeker</th><th>Subject</th><th>Grade</th><th>Tutor</th><th>Grade</th><th>Action</th></tr></thead>
        <tbody id="matchedList"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA9xmlbnn98hTKfWi5Of0OKHfy-nppTLNk",
    authDomain: "peer-2bd22.firebaseapp.com",
    databaseURL: "https://peer-2bd22-default-rtdb.firebaseio.com",
    projectId: "peer-2bd22",
    storageBucket: "peer-2bd22.appspot.com",
    messagingSenderId: "871101246393",
    appId: "1:871101246393:web:474ce51f90c8dff383a468"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  let currentUser = null;
  let username = null;

  function emailify(name) {
    return `${name}@peerapp.com`;
  }

  function login() {
    username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(emailify(username), password).catch(e => alert(e.message));
  }

  function signup() {
    username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;
    auth.createUserWithEmailAndPassword(emailify(username), password).catch(e => alert(e.message));
  }

  function logout() {
    auth.signOut();
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      username = user.email.split("@")[0];
      document.getElementById("authBox").classList.add("hide");
      document.getElementById("mainApp").classList.remove("hide");
      document.getElementById("displayUsername").textContent = username;
      syncData();
    } else {
      document.getElementById("authBox").classList.remove("hide");
      document.getElementById("mainApp").classList.add("hide");
    }
  });

  function toggleOther(select, otherId) {
    document.getElementById(otherId).style.display = select.value === "Other" ? "block" : "none";
  }

  function getSubject(selectId, otherId) {
    const select = document.getElementById(selectId);
    return select.value === "Other" ? document.getElementById(otherId).value.trim() : select.value;
  }

  function registerTutor() {
    const subject = getSubject("tutorSubject", "tutorOther");
    const grade = parseFloat(document.getElementById("tutorGrade").value);
    if (subject && !isNaN(grade)) {
      const id = db.ref("tutors").push().key;
      db.ref("tutors/" + id).set({ username, subject, grade });
      document.getElementById("tutorSubject").value = '';
      document.getElementById("tutorOther").value = '';
      document.getElementById("tutorGrade").value = '';
    }
  }

  function registerSeeker() {
    const subject = getSubject("seekerSubject", "seekerOther");
    const grade = parseFloat(document.getElementById("seekerGrade").value);
    if (subject && !isNaN(grade)) {
      const id = db.ref("seekers").push().key;
      db.ref("seekers/" + id).set({ username, subject, grade });
      document.getElementById("seekerSubject").value = '';
      document.getElementById("seekerOther").value = '';
      document.getElementById("seekerGrade").value = '';
    }
  }

  function matchSeeker(id, seeker) {
    db.ref("tutors").once("value", snap => {
      const tutors = snap.val();
      if (tutors) {
        const eligible = Object.entries(tutors).filter(([key, tutor]) =>
          tutor.subject.toLowerCase() === seeker.subject.toLowerCase() &&
          Math.abs(tutor.grade - seeker.grade) <= 3
        );

        if (eligible.length > 0) {
          eligible.sort((a, b) =>
            Math.abs(a[1].grade - seeker.grade) - Math.abs(b[1].grade - seeker.grade)
          );

          const [matchKey, matchTutor] = eligible[0];

          const matchId = db.ref("matches").push().key;
          db.ref("matches/" + matchId).set({
            seekerName: seeker.username,
            tutorName: matchTutor.username,
            subject: seeker.subject,
            seekerGrade: seeker.grade,
            tutorGrade: matchTutor.grade
          });

          db.ref("seekers/" + id).remove();
          db.ref("tutors/" + matchKey).remove();

          document.getElementById("matchMessage").textContent =
            `"${seeker.username}" matched with "${matchTutor.username}" successfully for "${seeker.subject}"`;
        } else {
          document.getElementById("matchMessage").textContent =
            `❌ No tutor found within 3 grades for "${seeker.subject}"`;
        }
      }
    });
  }

  function syncData() {
    db.ref("tutors").on("value", snap => {
      const data = snap.val() || {};
      document.getElementById("tutorList").innerHTML = Object.values(data).map(t => `
        <tr><td>${t.username}</td><td>${t.subject}</td><td>${t.grade}</td></tr>`).join('');
    });

    db.ref("seekers").on("value", snap => {
      const data = snap.val() || {};
      const list = Object.entries(data).map(([id, s]) => {
        const show = s.username === username;
        return `<tr>
          <td>${s.username}</td><td>${s.subject}</td><td>${s.grade}</td>
          <td>${show ? `<button onclick='matchSeeker("${id}", ${JSON.stringify(s)})'>Match Me</button>` : ""}</td>
        </tr>`;
      });
      document.getElementById("seekerList").innerHTML = list.join('');
    });

    db.ref("matches").on("value", snap => {
      const data = snap.val() || {};
      renderMatches(data);
    });
  }

  function renderMatches(data) {
    const list = document.getElementById("matchedList");
    list.innerHTML = '';
    for (let id in data) {
      const m = data[id];
      list.innerHTML += `<tr>
        <td>${m.seekerName}</td><td>${m.subject}</td><td>${m.seekerGrade}</td>
        <td>${m.tutorName}</td><td>${m.tutorGrade}</td>
        <td>
          <a href="chat.html?matchId=${id}"><button>Chat</button></a>
        </td>
      </tr>`;
    }
  }
</script>

</body>
</html>
